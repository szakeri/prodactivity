#! /usr/bin/env bash

REGISTRY='docker-registry.pdbld.f5net.com/prodactivity'
BASEIMAGE_REGID=${REGISTRY}'/base'
INSTALL_DIR=`python -c 'import os, prodactivity;print(\\
            os.path.dirname(os.path.abspath(prodactivity.__file__)))'`
ENV_DIR=${INSTALL_DIR}/environments

if [ "$1" == "upgrade" ]; then
      sudo pip install --upgrade git+https://github.com/zancas/prodactivity.git
    elif [ "$1" == "basepublish" ]; then
      docker build -t ${BASEIMAGE_REGID} -f ${ENV_DIR}/base ${INSTALL_DIR} \
      && docker push ${BASEIMAGE_REGID}
    elif [ "$1" == "selfpublish" ]; then
      echo ${INSTALL_DIR}
      echo ${USER}
      echo `id -u -r ${USER}`
      docker build --build-arg USER=${USER} \
                   --build-arg USER_ID=`id -u -r ${USER}` \
                   -t ${REGISTRY}/${USER} \
                   -f ${ENV_DIR}/user ${INSTALL_DIR} \
      && docker push ${REGISTRY}/${USER}
    else
      docker run --user ${USER} -it -v ${HOME}:/home/${USER} \
      -v /var/run/docker.sock:/var/run/docker.sock \
      -v ${HOME}/.ssh/id_rsa_bldrgit:/home/$USER/ssh_keys/id_rsa_bldrgit \
      -v ${HOME}/.ssh/id_rsa_testlab:/home/$USER/ssh_keys/id_rsa_testlab \
      ${REGISTRY}/${USER}:latest bash
fi
